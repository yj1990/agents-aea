
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="ie=edge" http-equiv="x-ua-compatible"/>
<meta content="Everything you need to know about Fetch.AI." name="description"/>
<link href="https://docs.fetch.ai/thermometer-skills-step-by-step/" rel="canonical"/>
<meta content="diarmid.campbell@fetch.ai" name="author"/>
<meta content="Copy to clipboard" name="lang:clipboard.copy"/>
<meta content="Copied to clipboard" name="lang:clipboard.copied"/>
<meta content="en" name="lang:search.language"/>
<meta content="True" name="lang:search.pipeline.stopwords"/>
<meta content="True" name="lang:search.pipeline.trimmer"/>
<meta content="No matching documents" name="lang:search.result.none"/>
<meta content="1 matching document" name="lang:search.result.one"/>
<meta content="# matching documents" name="lang:search.result.other"/>
<meta content="[\s\-]+" name="lang:search.tokenizer"/>
<link href="../assets/images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1, mkdocs-material-4.6.3" name="generator"/>
<title>Thermometer skills step-by-step - AEA Developer Documentation</title>
<link href="../assets/stylesheets/application.adb8469c.css" rel="stylesheet"/>
<script src="../assets/javascripts/modernizr.86422ebf.js"></script>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
<link href="../assets/fonts/material-icons.css" rel="stylesheet"/>
<link href="../css/my-styles.css" rel="stylesheet"/>
</head>
<body dir="ltr">
<svg class="md-svg">
<defs>
</defs>
</svg>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<a class="md-skip" href="#planning-the-aea" tabindex="0">
        Skip to content
      </a>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a aria-label="AEA Developer Documentation" class="md-header-nav__button md-logo" href="https://docs.fetch.ai/" title="AEA Developer Documentation">
<i class="md-icon">code</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
              AEA Developer Documentation
            </span>
<span class="md-header-nav__topic">
              
                Thermometer skills step-by-step
              
            </span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
</div>
</div>
</nav>
</header>
<div class="md-container">
<nav class="md-tabs md-tabs--active" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="..">
          AEA Framework
        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" role="main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title md-nav__title--site" for="__drawer">
<a class="md-nav__button md-logo" href="https://docs.fetch.ai/" title="AEA Developer Documentation">
<i class="md-icon">code</i>
</a>
    AEA Developer Documentation
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-toggle md-nav__toggle" data-md-toggle="nav-1" id="nav-1" type="checkbox"/>
<label class="md-nav__link" for="nav-1">
      AEA Framework
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="1">
<label class="md-nav__title" for="nav-1">
        AEA Framework
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href=".." title="Welcome">
      Welcome
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-2" id="nav-1-2" type="checkbox"/>
<label class="md-nav__link" for="nav-1-2">
      Concepts
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-1-2">
        Concepts
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../agent-oriented-development/" title="Agent-oriented development">
      Agent-oriented development
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../vision/" title="Vision">
      Vision
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../app-areas/" title="Application areas">
      Application areas
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../oef-ledger/" title="Relation to OEF and Ledger">
      Relation to OEF and Ledger
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../identity/" title="Identity">
      Identity
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../trust/" title="Trust issues">
      Trust issues
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-3" id="nav-1-3" type="checkbox"/>
<label class="md-nav__link" for="nav-1-3">
      Demos
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-1-3">
        Demos
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../aries-cloud-agent-demo/" title="Aries Cloud Agents Demo">
      Aries Cloud Agents Demo
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../car-park-skills/" title="Car park skills">
      Car park skills
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../generic-skills/" title="Generic skills">
      Generic skills
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../gym-example/" title="Gym example">
      Gym example
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../gym-skill/" title="Gym skill">
      Gym skill
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ml-skills/" title="ML skills">
      ML skills
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tac-skills/" title="TAC skills">
      TAC skills
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../tac/" title="TAC external app">
      TAC external app
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../weather-skills/" title="Weather skills">
      Weather skills
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../thermometer-skills/" title="Thermometer skills">
      Thermometer skills
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4" id="nav-1-4" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4">
      Development
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="2">
<label class="md-nav__title" for="nav-1-4">
        Development
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-1" id="nav-1-4-1" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-1">
      Getting started
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-1">
        Getting started
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../steps/" title="Ways to build an AEA">
      Ways to build an AEA
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../quickstart/" title="AEA quick start">
      AEA quick start
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../aea-vs-mvc/" title="AEA and web frameworks">
      AEA and web frameworks
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../build-aea-step-by-step/" title="Build an AEA with the CLI">
      Build an AEA with the CLI
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../skill-guide/" title="Build a skill for an AEA">
      Build a skill for an AEA
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../build-aea-programmatically/" title="Build an AEA programmatically">
      Build an AEA programmatically
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../agent-vs-aea/" title="AEAs vs agents">
      AEAs vs agents
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cli-vs-programmatic-aeas/" title="CLI vs programmatic AEAs">
      CLI vs programmatic AEAs
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-2" id="nav-1-4-2" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-2">
      Step by step guides
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-2">
        Step by step guides
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-toggle md-nav__toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        Thermometer skills step-by-step
      </label>
<a class="md-nav__link md-nav__link--active" href="./" title="Thermometer skills step-by-step">
      Thermometer skills step-by-step
    </a>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#planning-the-aea">
    Planning the AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dependencies">
    Dependencies
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup-the-environment">
    Setup the environment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thermometer-aea">
    Thermometer AEA
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#step-1-create-the-aea">
    Step 1: Create the AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-2-create-the-behaviour">
    Step 2: Create the behaviour
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-3-create-the-handler">
    Step 3: Create the handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-4-create-the-strategy">
    Step 4: Create the strategy
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-5-create-the-dialogues">
    Step 5: Create the dialogues
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-6-create-the-data_model">
    Step 6: Create the data_model
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-7-update-the-yaml-files">
    Step 7: Update the YAML files
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#client_aea">
    Client_AEA
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#step-1-create-the-aea_1">
    Step 1: Create the AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-2-create-the-behaviour_1">
    Step 2: Create the behaviour
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-3-create-the-handler_1">
    Step 3: Create the handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-4-create-the-strategy_1">
    Step 4: Create the strategy
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-5-create-the-dialogues_1">
    Step 5: Create the dialogues
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-6-update-the-yaml-files">
    Step 6: Update the YAML files
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-the-aeas">
    Run the AEAs
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fetchai-ledger-payment">
    Fetch.ai ledger payment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-the-aea-configs">
    Update the AEA configs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fund-the-temperature-client-aea">
    Fund the temperature client AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ethereum-ledger-payment">
    Ethereum ledger payment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-the-aea-configs_1">
    Update the AEA configs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-the-skill-configs">
    Update the skill configs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fund-the-thermometer-client-aea">
    Fund the thermometer client AEA
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#delete-the-aeas">
    Delete the AEAs
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-3" id="nav-1-4-3" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-3">
      Use case components
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-3">
        Use case components
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../generic-skills/" title="Generic skills">
      Generic skills
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../orm-integration/" title="ORM integration">
      ORM integration
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../connect-a-frontend/" title="Frontend intergration">
      Frontend intergration
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../erc1155-skills/" title="ERC1155 deploy and interact">
      ERC1155 deploy and interact
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../http-connection-and-skill/" title="HTTP Connection">
      HTTP Connection
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../aries-cloud-agent-example/" title="Identity - Aries Cloud Agent">
      Identity - Aries Cloud Agent
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../p2p-connection/" title="P2P Connection">
      P2P Connection
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-4" id="nav-1-4-4" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-4">
      Architecture
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-4">
        Architecture
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../design-principles/" title="Design principles">
      Design principles
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../diagram/" title="Architectural diagram">
      Architectural diagram
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../core-components/" title="Core components">
      Core components
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-5" id="nav-1-4-5" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-5">
      CLI
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-5">
        CLI
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../cli-how-to/" title="Installation">
      Installation
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cli-commands/" title="Commands">
      Commands
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../package-imports/" title="File structure">
      File structure
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../cli-gui/" title="GUI">
      GUI
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../wealth/" title="Generating wealth">
      Generating wealth
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-6" id="nav-1-4-6" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-6">
      Search &amp; Discovery
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-6">
        Search &amp; Discovery
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../defining-data-models/" title="Defining Data Models">
      Defining Data Models
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../query-language/" title="The Query Language">
      The Query Language
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-7" id="nav-1-4-7" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-7">
      Developer guides
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-7">
        Developer guides
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../version/" title="Version">
      Version
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../skill/" title="Skill">
      Skill
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../protocol/" title="Protocol">
      Protocol
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../connection/" title="Connection">
      Connection
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../scaffolding/" title="Scaffolding packages">
      Scaffolding packages
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../protocol-generator/" title="Generating protocols">
      Generating protocols
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../logging/" title="Logging">
      Logging
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../raspberry-set-up/" title="Build an AEA on a Raspberry Pi">
      Build an AEA on a Raspberry Pi
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ledger-integration/" title="Using public ledgers">
      Using public ledgers
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../multiplexer-standalone/" title="Use multiplexer stand-alone">
      Use multiplexer stand-alone
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../standalone-transaction/" title="Create stand-alone transaction">
      Create stand-alone transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../decision-maker-transaction/" title="Create decision-maker transaction">
      Create decision-maker transaction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../deployment/" title="Deployment">
      Deployment
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../known-limits/" title="Known limitations">
      Known limitations
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../performance_benchmark/" title="Performance benchmark">
      Performance benchmark
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9" id="nav-1-4-9" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9">
      API
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="3">
<label class="md-nav__title" for="nav-1-4-9">
        API
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/aea/" title="AEA">
      AEA
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/aea_builder/" title="AEA Builder">
      AEA Builder
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/agent/" title="Agent">
      Agent
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-4" id="nav-1-4-9-4" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-4">
      Configurations
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-4">
        Configurations
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/configurations/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/configurations/components/" title="Components">
      Components
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/configurations/loader/" title="Loader">
      Loader
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-5" id="nav-1-4-9-5" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-5">
      Connections
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-5">
        Connections
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/connections/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/connections/stub/connection/" title="Stub Connection">
      Stub Connection
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/context/base/" title="Context">
      Context
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-7" id="nav-1-4-9-7" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-7">
      Contracts
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-7">
        Contracts
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/contracts/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/contracts/ethereum/" title="Ethereum">
      Ethereum
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-8" id="nav-1-4-9-8" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-8">
      Crypto
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-8">
        Crypto
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/crypto/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/crypto/ethereum/" title="Ethereum">
      Ethereum
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/crypto/fetchai/" title="Fetchai">
      Fetchai
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/crypto/ledger_apis/" title="LedgerApis">
      LedgerApis
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/crypto/wallet/" title="Wallet">
      Wallet
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-9" id="nav-1-4-9-9" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-9">
      Decision Maker
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-9">
        Decision Maker
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/decision_maker/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-9-2" id="nav-1-4-9-9-2" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-9-2">
      Messages
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="5">
<label class="md-nav__title" for="nav-1-4-9-9-2">
        Messages
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/decision_maker/messages/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/decision_maker/messages/state_update/" title="State Update">
      State Update
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/decision_maker/messages/transaction/" title="Transaction">
      Transaction
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-10" id="nav-1-4-9-10" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-10">
      Helpers
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-10">
        Helpers
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-10-1" id="nav-1-4-9-10-1" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-10-1">
      Dialogue
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="5">
<label class="md-nav__title" for="nav-1-4-9-10-1">
        Dialogue
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/helpers/dialogue/base/" title="Base">
      Base
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-10-2" id="nav-1-4-9-10-2" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-10-2">
      IPFS
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="5">
<label class="md-nav__title" for="nav-1-4-9-10-2">
        IPFS
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/helpers/ipfs/base/" title="Base">
      Base
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-10-3" id="nav-1-4-9-10-3" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-10-3">
      Preferences
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="5">
<label class="md-nav__title" for="nav-1-4-9-10-3">
        Preferences
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/helpers/preference_representations/base/" title="Base">
      Base
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-10-4" id="nav-1-4-9-10-4" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-10-4">
      Search
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="5">
<label class="md-nav__title" for="nav-1-4-9-10-4">
        Search
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/helpers/search/generic/" title="Generic">
      Generic
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/helpers/search/models/" title="Models">
      Models
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/identity/base/" title="Identity">
      Identity
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/mail/base/" title="Mail">
      Mail
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-13" id="nav-1-4-9-13" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-13">
      Protocols
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-13">
        Protocols
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/protocols/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/protocols/generator/" title="Generator">
      Generator
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-13-3" id="nav-1-4-9-13-3" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-13-3">
      Default Protocol
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="5">
<label class="md-nav__title" for="nav-1-4-9-13-3">
        Default Protocol
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/protocols/default/custom_types/" title="Custom Types">
      Custom Types
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/protocols/default/message/" title="Message">
      Message
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/protocols/default/serialization/" title="Serialization">
      Serialization
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/registries/resources/" title="Resources">
      Resources
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-toggle md-nav__toggle" data-md-toggle="nav-1-4-9-15" id="nav-1-4-9-15" type="checkbox"/>
<label class="md-nav__link" for="nav-1-4-9-15">
      Skills
    </label>
<nav class="md-nav" data-md-component="collapsible" data-md-level="4">
<label class="md-nav__title" for="nav-1-4-9-15">
        Skills
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../api/skills/base/" title="Base">
      Base
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/skills/error/handlers/" title="Error Skill">
      Error Skill
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/skills/behaviours/" title="Behaviors">
      Behaviors
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../api/skills/tasks/" title="Task">
      Task
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../questions-and-answers/" title="Q&amp;A">
      Q&amp;A
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#planning-the-aea">
    Planning the AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#dependencies">
    Dependencies
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#setup-the-environment">
    Setup the environment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#thermometer-aea">
    Thermometer AEA
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#step-1-create-the-aea">
    Step 1: Create the AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-2-create-the-behaviour">
    Step 2: Create the behaviour
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-3-create-the-handler">
    Step 3: Create the handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-4-create-the-strategy">
    Step 4: Create the strategy
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-5-create-the-dialogues">
    Step 5: Create the dialogues
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-6-create-the-data_model">
    Step 6: Create the data_model
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-7-update-the-yaml-files">
    Step 7: Update the YAML files
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#client_aea">
    Client_AEA
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#step-1-create-the-aea_1">
    Step 1: Create the AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-2-create-the-behaviour_1">
    Step 2: Create the behaviour
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-3-create-the-handler_1">
    Step 3: Create the handler
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-4-create-the-strategy_1">
    Step 4: Create the strategy
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-5-create-the-dialogues_1">
    Step 5: Create the dialogues
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#step-6-update-the-yaml-files">
    Step 6: Update the YAML files
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#run-the-aeas">
    Run the AEAs
  </a>
<nav class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#fetchai-ledger-payment">
    Fetch.ai ledger payment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-the-aea-configs">
    Update the AEA configs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fund-the-temperature-client-aea">
    Fund the temperature client AEA
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ethereum-ledger-payment">
    Ethereum ledger payment
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-the-aea-configs_1">
    Update the AEA configs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#update-the-skill-configs">
    Update the skill configs
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fund-the-thermometer-client-aea">
    Fund the thermometer client AEA
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#delete-the-aeas">
    Delete the AEAs
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<h1>Thermometer skills step-by-step</h1>
<p>This guide is a step-by-step introduction to building an AEA that represents static, and dynamic data to be advertised on the Open Economic Framework.</p>
<p>If you simply want to run the resulting AEAs <a href="../thermometer-skills">go here</a>.</p>
<h2 id="planning-the-aea">Planning the AEA</h2>
<p>To follow this tutorial to completion you will need:
 - Raspberry Pi 4</p>
<ul>
<li>
<p>Mini SD card</p>
</li>
<li>
<p>Thermometer sensor</p>
</li>
<li>
<p>AEA Framework</p>
</li>
</ul>
<p>The AEA will “live” inside the Raspberry Pi and will read the data from a sensor. Then it will connect to the <a href="../oef-ledger">OEF search and communication node</a> and will identify itself as a seller of that data.</p>
<h2 id="dependencies">Dependencies</h2>
<p>Follow the <a href="../quickstart/#preliminaries">Preliminaries</a> and <a href="../quickstart/#installation">Installation</a> sections from the AEA quick start.</p>
<h2 id="setup-the-environment">Setup the environment</h2>
<p>You can follow this link <a href="#raspberry-set-up.md"> here </a> in order to setup your environment and prepare your raspberry.</p>
<p>Once you setup your raspberry </p>
<p>Open a terminal and navigate to <code>/etc/udev/rules.d/</code>. Create a new file there 
(I named mine 99-hidraw-permissions.rules)
<div class="highlight"><pre><span></span><code>sudo nano <span class="m">99</span>-hidraw-permissions.rules
</code></pre></div>
and add the following inside the file:
<div class="highlight"><pre><span></span><code><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">"hidraw*"</span>, <span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">"hidraw"</span>, <span class="nv">MODE</span><span class="o">=</span><span class="s2">"0664"</span>, <span class="nv">GROUP</span><span class="o">=</span><span class="s2">"plugdev"</span>
</code></pre></div>
this assigns all devices coming out of the hidraw subsystem in the kernel to the group plugdev and sets the permissions 
to r/w r/w r (for root [the default owner], plugdev, and everyone else respectively)</p>
<h2 id="thermometer-aea">Thermometer AEA</h2>
<h3 id="step-1-create-the-aea">Step 1: Create the AEA</h3>
<p>Create a new AEA by typing the following command in the terminal: 
<div class="highlight"><pre><span></span><code>aea create my_thermometer
<span class="nb">cd</span> my_thermometer
</code></pre></div>
Our newly created AEA is inside the current working directory. Let’s create our new skill that will handle the sale of the thermomemeter data. Type the following command:
<div class="highlight"><pre><span></span><code>aea scaffold skill thermometer
</code></pre></div></p>
<p>This command will create the correct structure for a new skill inside our AEA project You can locate the newly created skill inside the skills folder and it must contain the following files:</p>
<ul>
<li><code>behaviours.py</code></li>
<li><code>handlers.py</code></li>
<li><code>my_model.py</code></li>
<li><code>skills.yaml</code></li>
<li><code>__init__.py</code></li>
</ul>
<h3 id="step-2-create-the-behaviour">Step 2: Create the behaviour</h3>
<p>A Behaviour class contains the business logic specific to actions initiated by the AEA rather than reactions to other events.</p>
<p>Open the behaviours.py (<code>my_thermometer/skills/thermometer/behaviours.py</code>) and add the following code:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">aea.crypto.ethereum</span> <span class="kn">import</span> <span class="n">ETHEREUM</span>
<span class="kn">from</span> <span class="nn">aea.crypto.fetchai</span> <span class="kn">import</span> <span class="n">FETCHAI</span>
<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Description</span>
<span class="kn">from</span> <span class="nn">aea.skills.behaviours</span> <span class="kn">import</span> <span class="n">TickerBehaviour</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.oef_search.message</span> <span class="kn">import</span> <span class="n">OefSearchMessage</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.oef_search.serialization</span> <span class="kn">import</span> <span class="n">OefSearchSerializer</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer.strategy</span> <span class="kn">import</span> <span class="n">Strategy</span>

<span class="n">DEFAULT_SERVICES_INTERVAL</span> <span class="o">=</span> <span class="mf">30.0</span>


<span class="k">class</span> <span class="nc">ServiceRegistrationBehaviour</span><span class="p">(</span><span class="n">TickerBehaviour</span><span class="p">):</span>
    <span class="sd">"""This class implements a behaviour."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""Initialise the behaviour."""</span>
        <span class="n">services_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
            <span class="s2">"services_interval"</span><span class="p">,</span> <span class="n">DEFAULT_SERVICES_INTERVAL</span>
        <span class="p">)</span>  <span class="c1"># type: int</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tick_interval</span><span class="o">=</span><span class="n">services_interval</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registered_service_description</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Description]</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the setup.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_fetchai</span><span class="p">:</span>
            <span class="n">fet_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">FETCHAI</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FETCHAI</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">fet_balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: starting balance on fetchai ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">fet_balance</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: you have no starting balance on fetchai ledger!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_ethereum</span><span class="p">:</span>
            <span class="n">eth_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">ETHEREUM</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ETHEREUM</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">eth_balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: starting balance on ethereum ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">eth_balance</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: you have no starting balance on ethereum ledger!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_register_service</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the act.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_service</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register_service</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the task teardown.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_fetchai</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">FETCHAI</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FETCHAI</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: ending balance on fetchai ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">balance</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_ethereum</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">ETHEREUM</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ETHEREUM</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: ending balance on ethereum ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">balance</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_unregister_service</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_register_service</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Register to the OEF Service Directory.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_service_description</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registered_service_description</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="n">oef_msg_id</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_next_oef_msg_id</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">OefSearchMessage</span><span class="p">(</span>
            <span class="n">performative</span><span class="o">=</span><span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">REGISTER_SERVICE</span><span class="p">,</span>
            <span class="n">dialogue_reference</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oef_msg_id</span><span class="p">),</span> <span class="s2">""</span><span class="p">),</span>
            <span class="n">service_description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
            <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">search_service_address</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
            <span class="n">protocol_id</span><span class="o">=</span><span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">OefSearchSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: updating thermometer services on OEF service directory."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unregister_service</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Unregister service from OEF Service Directory.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="n">oef_msg_id</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_next_oef_msg_id</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">OefSearchMessage</span><span class="p">(</span>
            <span class="n">performative</span><span class="o">=</span><span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">UNREGISTER_SERVICE</span><span class="p">,</span>
            <span class="n">dialogue_reference</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">oef_msg_id</span><span class="p">),</span> <span class="s2">""</span><span class="p">),</span>
            <span class="n">service_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_registered_service_description</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
            <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">search_service_address</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
            <span class="n">protocol_id</span><span class="o">=</span><span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">OefSearchSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: unregistering thermometer station services from OEF service directory."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registered_service_description</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<p>This Behaviour will register and de-register our AEA’s service on the <a href="../oef-ledger">OEF search node</a> at regular tick intervals (here 30 seconds). By registering, the AEA becomes discoverable to possible clients.</p>
<p>The act method unregisters and registers the AEA to the <a href="../oef-ledger">OEF search node</a> on each tick. Finally, the teardown method unregisters the AEA and reports your balances.</p>
<p>Currently, the AEA-framework supports two different blockchains [Ethereum, Fetchai], and that’s the reason we are checking if we have balance for these two blockchains in the setup method.</p>
<h3 id="step-3-create-the-handler">Step 3: Create the handler</h3>
<p>So far, we have tasked the AEA with sending register/unregister requests to the <a href="../oef-ledger">OEF search node</a>. However, we have so far no way of handling the responses sent to the AEA by the <a href="../oef-ledger">OEF search node</a> or messages sent from any other AEA.</p>
<p>We have to specify the logic to negotiate with another AEA based on the strategy we want our AEA to follow. The following diagram illustrates the negotiation flow, up to the agreement between a seller_AEA and a client_AEA.</p>
<div class="mermaid">
    sequenceDiagram
        participant Search
        participant Client_AEA
        participant Seller_AEA
        participant Blockchain

        activate Client_AEA
        activate Search
        activate Seller_AEA
        activate Blockchain

        Seller_AEA-&gt;&gt;Search: register_service
        Client_AEA-&gt;&gt;Search: search
        Search--&gt;&gt;Client_AEA: list_of_agents
        Client_AEA-&gt;&gt;Seller_AEA: call_for_proposal
        Seller_AEA-&gt;&gt;Client_AEA: propose
        Client_AEA-&gt;&gt;Seller_AEA: accept
        Seller_AEA-&gt;&gt;Client_AEA: match_accept
        Client_AEA-&gt;&gt;Blockchain: transfer_funds
        Client_AEA-&gt;&gt;Seller_AEA: send_transaction_hash
        Seller_AEA-&gt;&gt;Blockchain: check_transaction_status
        Seller_AEA-&gt;&gt;Client_AEA: send_data

        deactivate Client_AEA
        deactivate Search
        deactivate Seller_AEA
        deactivate Blockchain

</div>
<p>In the context of our thermometer use-case, the <code>my_thermometer</code> AEA is the seller.</p>
<p>Let us now implement a handler to deal with the incoming messages. Open the <code>handlers.py</code> file (<code>my_thermometer/skills/thermometer/handlers.py</code>) and add the following code:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">aea.configurations.base</span> <span class="kn">import</span> <span class="n">ProtocolId</span>
<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">aea.protocols.base</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">aea.protocols.default.message</span> <span class="kn">import</span> <span class="n">DefaultMessage</span>
<span class="kn">from</span> <span class="nn">aea.protocols.default.serialization</span> <span class="kn">import</span> <span class="n">DefaultSerializer</span>
<span class="kn">from</span> <span class="nn">aea.skills.base</span> <span class="kn">import</span> <span class="n">Handler</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.fipa.message</span> <span class="kn">import</span> <span class="n">FipaMessage</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.fipa.serialization</span> <span class="kn">import</span> <span class="n">FipaSerializer</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer.dialogues</span> <span class="kn">import</span> <span class="n">Dialogue</span><span class="p">,</span> <span class="n">Dialogues</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer.strategy</span> <span class="kn">import</span> <span class="n">Strategy</span>


<span class="k">class</span> <span class="nc">FIPAHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">"""This class scaffolds a handler."""</span>

    <span class="n">SUPPORTED_PROTOCOL</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span>  <span class="c1"># type: Optional[ProtocolId]</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Implement the setup for the handler."""</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the reaction to a message.</span>

<span class="sd">        :param message: the message</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="c1"># convenience representations</span>
        <span class="n">fipa_msg</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">FipaMessage</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">dialogue_reference</span> <span class="o">=</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">dialogue_reference</span>

        <span class="c1"># recover dialogue</span>
        <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">is_belonging_to_registered_dialogue</span><span class="p">(</span>
            <span class="n">fipa_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span>
        <span class="p">):</span>
            <span class="n">dialogue</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="p">,</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">get_dialogue</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">incoming_extend</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">is_permitted_for_new_dialogue</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">):</span>
            <span class="n">dialogue</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="p">,</span>
                <span class="n">dialogues</span><span class="o">.</span><span class="n">create_opponent_initiated</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                    <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue_reference</span><span class="p">,</span>
                    <span class="n">is_seller</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">incoming_extend</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_unidentified_dialogue</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># handle message</span>
        <span class="k">if</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">CFP</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_cfp</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">DECLINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_decline</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">ACCEPT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_accept</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">INFORM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_inform</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the handler teardown.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">pass</span>
</code></pre></div>
The code above is logic for handling <code>FipaMessages</code> received by the <code>my_thermometer</code> AEA. We use <code>Dialogues</code> to keep track of the dialogue state between the <code>my_thermometer</code> and the <code>client_aea</code>.</p>
<p>First, we check if the message is registered to an existing dialogue or if we have to create a new dialogue. The second part assigns messages to their handler based on the message's performative. We are going to implement each case in a different function.</p>
<p>Below the <code>teardown</code> function, we continue by adding the following code:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_unidentified_dialogue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle an unidentified dialogue.</span>

<span class="sd">        Respond to the sender with a default message containing the appropriate error information.</span>

<span class="sd">        :param msg: the message</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: unidentified dialogue."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">default_msg</span> <span class="o">=</span> <span class="n">DefaultMessage</span><span class="p">(</span>
            <span class="n">dialogue_reference</span><span class="o">=</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
            <span class="n">message_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">performative</span><span class="o">=</span><span class="n">DefaultMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">DefaultMessage</span><span class="o">.</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">INVALID_DIALOGUE</span><span class="p">,</span>
            <span class="n">error_msg</span><span class="o">=</span><span class="s2">"Invalid dialogue."</span><span class="p">,</span>
            <span class="n">error_data</span><span class="o">=</span><span class="p">{</span><span class="s2">"fipa_message"</span><span class="p">:</span> <span class="sa">b</span><span class="s2">""</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
            <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
            <span class="n">protocol_id</span><span class="o">=</span><span class="n">DefaultMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">DefaultSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">default_msg</span><span class="p">),</span>
        <span class="p">)</span>
</code></pre></div>
<p>The above code handles an unidentified dialogue by responding to the sender with a <code>DefaultMessage</code> containing the appropriate error information. </p>
<p>The next code block handles the CFP message, paste the code below the <code>_handle_unidentified_dialogue</code> function:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_cfp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the CFP.</span>

<span class="sd">        If the CFP matches the supplied services then send a PROPOSE, otherwise send a DECLINE.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">new_message_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_target</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received CFP from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Query</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strategy</span><span class="o">.</span><span class="n">is_matching_supply</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
            <span class="n">proposal</span><span class="p">,</span> <span class="n">temp_data</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">generate_proposal_and_data</span><span class="p">(</span>
                <span class="n">query</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">temp_data</span> <span class="o">=</span> <span class="n">temp_data</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="n">proposal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: sending sender=</span><span class="si">{}</span><span class="s2"> a PROPOSE with proposal=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:],</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">proposal_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">PROPOSE</span><span class="p">,</span>
                <span class="n">proposal</span><span class="o">=</span><span class="n">proposal</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">proposal_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">proposal_msg</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: declined the CFP from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">decline_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">DECLINE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">decline_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">decline_msg</span><span class="p">),</span>
            <span class="p">)</span>
</code></pre></div>
<p>The above code will respond with a <code>Proposal</code> to the client if the CFP matches the supplied services and our strategy otherwise it will respond with a <code>Decline</code> message. </p>
<p>The next code-block  handles the decline message we receive from the client. Add the following code below the <code>_handle_cfp</code>function:</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_decline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the DECLINE.</span>

<span class="sd">        Close the dialogue.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received DECLINE from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
        <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogue_stats</span><span class="o">.</span><span class="n">add_dialogue_endstate</span><span class="p">(</span>
            <span class="n">Dialogue</span><span class="o">.</span><span class="n">EndState</span><span class="o">.</span><span class="n">DECLINED_PROPOSE</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">is_self_initiated</span>
        <span class="p">)</span>
</code></pre></div>
If we receive a decline message from the client we close the dialogue and terminate this conversation with the <code>client_aea</code>.</p>
<p>Alternatively, we might receive an <code>Accept</code> message. Inorder to handle this option add the following code below the <code>_handle_decline</code> function:</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the ACCEPT.</span>

<span class="sd">        Respond with a MATCH_ACCEPT_W_INFORM which contains the address to send the funds to.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">new_message_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_target</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received ACCEPT from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: sending MATCH_ACCEPT_W_INFORM to sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">proposal</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">proposal</span><span class="p">)</span>
        <span class="n">identifier</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ledger_id"</span><span class="p">))</span>
        <span class="n">match_accept_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
            <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
            <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="n">new_target</span><span class="p">,</span>
            <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">MATCH_ACCEPT_W_INFORM</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s2">"address"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="p">[</span><span class="n">identifier</span><span class="p">]},</span>
        <span class="p">)</span>
        <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">match_accept_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
            <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
            <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">match_accept_msg</span><span class="p">),</span>
        <span class="p">)</span>
</code></pre></div>
When the <code>client_aea</code> accepts the <code>Proposal</code> we send it, we have to respond with another message (<code>MATCH_ACCEPT_W_INFORM</code> ) to inform the client about the address we would like it to send the funds to.</p>
<p>Lastly, when we receive the <code>Inform</code> message it means that the client has sent the funds to the provided address. Add the following code:</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the INFORM.</span>

<span class="sd">        If the INFORM message contains the transaction_digest then verify that it is settled, otherwise do nothing.</span>
<span class="sd">        If the transaction is settled send the temperature data, otherwise do nothing.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">new_message_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_target</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received INFORM from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">.</span><span class="n">is_ledger_tx</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">"transaction_digest"</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">tx_digest</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">"transaction_digest"</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: checking whether transaction=</span><span class="si">{}</span><span class="s2"> has been received ..."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">tx_digest</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">proposal</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">proposal</span><span class="p">)</span>
            <span class="n">ledger_id</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"ledger_id"</span><span class="p">))</span>
            <span class="n">is_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">is_tx_valid</span><span class="p">(</span>
                <span class="n">ledger_id</span><span class="p">,</span>
                <span class="n">tx_digest</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="p">[</span><span class="n">ledger_id</span><span class="p">],</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tx_nonce"</span><span class="p">)),</span>
                <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"price"</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="n">token_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                    <span class="n">ledger_id</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ledger_id</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: transaction=</span><span class="si">{}</span><span class="s2"> settled, new balance=</span><span class="si">{}</span><span class="s2">. Sending data to sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span>
                        <span class="n">tx_digest</span><span class="p">,</span>
                        <span class="n">token_balance</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:],</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">inform_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                    <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                    <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">new_target</span><span class="p">,</span>
                    <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">INFORM</span><span class="p">,</span>
                    <span class="n">info</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">temp_data</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                    <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                    <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                    <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
                <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogue_stats</span><span class="o">.</span><span class="n">add_dialogue_endstate</span><span class="p">(</span>
                    <span class="n">Dialogue</span><span class="o">.</span><span class="n">EndState</span><span class="o">.</span><span class="n">SUCCESSFUL</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">is_self_initiated</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: transaction=</span><span class="si">{}</span><span class="s2"> not settled, aborting"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">tx_digest</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">"Done"</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">inform_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">INFORM</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">temp_data</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
            <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogue_stats</span><span class="o">.</span><span class="n">add_dialogue_endstate</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="o">.</span><span class="n">EndState</span><span class="o">.</span><span class="n">SUCCESSFUL</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">is_self_initiated</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: did not receive transaction digest from sender=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>
We are checking the inform message. If it contains the transaction digest we verify that transaction matches the proposal that the client accepted. If the transaction is valid and we received the funds then we send the data to the client. 
Otherwise we do not send the data.</p>
<h3 id="step-4-create-the-strategy">Step 4: Create the strategy</h3>
<p>We are going to create the strategy that we want our AEA to follow. Rename the <code>my_model.py</code> file to <code>strategy.py</code> and paste the following code: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">temper</span> <span class="kn">import</span> <span class="n">Temper</span>

<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">aea.mail.base</span> <span class="kn">import</span> <span class="n">Address</span>
<span class="kn">from</span> <span class="nn">aea.skills.base</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer.thermometer_data_model</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SCHEME</span><span class="p">,</span>
    <span class="n">Thermometer_Datamodel</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">DEFAULT_PRICE_PER_ROW</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">DEFAULT_SELLER_TX_FEE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DEFAULT_CURRENCY_PBK</span> <span class="o">=</span> <span class="s2">"FET"</span>
<span class="n">DEFAULT_LEDGER_ID</span> <span class="o">=</span> <span class="s2">"fetchai"</span>
<span class="n">DEFAULT_IS_LEDGER_TX</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DEFAULT_HAS_SENSOR</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">Strategy</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""This class defines a strategy for the agent."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Initialize the strategy of the agent.</span>

<span class="sd">        :param register_as: determines whether the agent registers as seller, buyer or both</span>
<span class="sd">        :param search_for: determines whether the agent searches for sellers, buyers or both</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_price_per_row</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"price_per_row"</span><span class="p">,</span> <span class="n">DEFAULT_PRICE_PER_ROW</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seller_tx_fee</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"seller_tx_fee"</span><span class="p">,</span> <span class="n">DEFAULT_SELLER_TX_FEE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currency_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"currency_id"</span><span class="p">,</span> <span class="n">DEFAULT_CURRENCY_PBK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ledger_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"ledger_id"</span><span class="p">,</span> <span class="n">DEFAULT_LEDGER_ID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ledger_tx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"is_ledger_tx"</span><span class="p">,</span> <span class="n">DEFAULT_IS_LEDGER_TX</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_sensor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"has_sensor"</span><span class="p">,</span> <span class="n">DEFAULT_HAS_SENSOR</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oef_msg_id</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div>
<p>We initialise the strategy class. We are trying to read the strategy variables from the yaml file. If this is not 
possible we specified some default values.</p>
<p>The following functions are related with 
the <a href="../oef-ledger">OEF search node</a> registration and we assume that the query matches the supply. Add them under the initialization of the class:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_next_oef_msg_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Get the next oef msg id.</span>

<span class="sd">        :return: the next oef msg id</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_oef_msg_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oef_msg_id</span>

    <span class="k">def</span> <span class="nf">get_service_description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Description</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Get the service description.</span>

<span class="sd">        :return: a description of the offered services</span>
<span class="sd">        """</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="n">Description</span><span class="p">(</span><span class="n">SCHEME</span><span class="p">,</span> <span class="n">data_model</span><span class="o">=</span><span class="n">Thermometer_Datamodel</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">desc</span>

    <span class="k">def</span> <span class="nf">is_matching_supply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Check if the query matches the supply.</span>

<span class="sd">        :param query: the query</span>
<span class="sd">        :return: bool indiciating whether matches or not</span>
<span class="sd">        """</span>
        <span class="c1"># TODO, this is a stub</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">generate_proposal_and_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="n">Query</span><span class="p">,</span> <span class="n">counterparty</span><span class="p">:</span> <span class="n">Address</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Description</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
        <span class="sd">"""</span>
<span class="sd">        Generate a proposal matching the query.</span>

<span class="sd">        :param counterparty: the counterparty of the proposal.</span>
<span class="sd">        :param query: the query</span>
<span class="sd">        :return: a tuple of proposal and the temprature data</span>
<span class="sd">        """</span>

        <span class="n">tx_nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">generate_tx_nonce</span><span class="p">(</span>
            <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ledger_id</span><span class="p">,</span>
            <span class="n">seller</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ledger_id</span><span class="p">],</span>
            <span class="n">client</span><span class="o">=</span><span class="n">counterparty</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">temp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_data_payload</span><span class="p">()</span>
        <span class="n">total_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_price_per_row</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">total_price</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seller_tx_fee</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">"This sale would generate a loss, change the configs!"</span>
        <span class="n">proposal</span> <span class="o">=</span> <span class="n">Description</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">"price"</span><span class="p">:</span> <span class="n">total_price</span><span class="p">,</span>
                <span class="s2">"seller_tx_fee"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seller_tx_fee</span><span class="p">,</span>
                <span class="s2">"currency_id"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currency_id</span><span class="p">,</span>
                <span class="s2">"ledger_id"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ledger_id</span><span class="p">,</span>
                <span class="s2">"tx_nonce"</span><span class="p">:</span> <span class="n">tx_nonce</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">proposal</span><span class="p">,</span> <span class="n">temp_data</span>

    <span class="k">def</span> <span class="nf">_build_data_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">"""</span>
<span class="sd">        Build the data payload.</span>

<span class="sd">        :return: a tuple of the data and the rows</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_sensor</span><span class="p">:</span>
            <span class="n">temper</span> <span class="o">=</span> <span class="n">Temper</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">temper</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">"internal temperature"</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">degrees</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"thermometer_data"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">)}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">"Couldn't read the sensor I am re-trying."</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">degrees</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"thermometer_data"</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">randrange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">))}</span>  <span class="c1"># nosec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">degrees</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">degrees</span>
</code></pre></div>
<p>Before the creation of the actual proposal, we have to check if this sale generates value for us or a loss. If it is a loss, we abort and warn the developer. The helper private function <code>_build_data_payload</code>, is where we read data from our sensor or in case we don’t have a sensor generate a random number.</p>
<h3 id="step-5-create-the-dialogues">Step 5: Create the dialogues</h3>
<p>When we are negotiating with other AEA we would like to keep track on these negotiations for various reasons. 
So create a new file and name it dialogues.py. Inside this file add the following code: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">aea.helpers.dialogue.base</span> <span class="kn">import</span> <span class="n">DialogueLabel</span>
<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Description</span>
<span class="kn">from</span> <span class="nn">aea.skills.base</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.fipa.dialogues</span> <span class="kn">import</span> <span class="n">FipaDialogue</span><span class="p">,</span> <span class="n">FipaDialogues</span>


<span class="k">class</span> <span class="nc">Dialogue</span><span class="p">(</span><span class="n">FipaDialogue</span><span class="p">):</span>
    <span class="sd">"""The dialogue class maintains state of a dialogue and manages it."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialogue_label</span><span class="p">:</span> <span class="n">DialogueLabel</span><span class="p">,</span> <span class="n">is_seller</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Initialize a dialogue label.</span>

<span class="sd">        :param dialogue_label: the identifier of the dialogue</span>
<span class="sd">        :param is_seller: indicates whether the agent associated with the dialogue is a seller or buyer</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">FipaDialogue</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialogue_label</span><span class="o">=</span><span class="n">dialogue_label</span><span class="p">,</span> <span class="n">is_seller</span><span class="o">=</span><span class="n">is_seller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Dict[str, str]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Description]</span>


<span class="k">class</span> <span class="nc">Dialogues</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">FipaDialogues</span><span class="p">):</span>
    <span class="sd">"""The dialogues class keeps track of all dialogues."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Initialize dialogues.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">Model</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">FipaDialogues</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<p>The dialogues class stores dialogue with each <code>client_aea</code> in a list so we can have access to previous messages and 
enable us to identify possible communications problems between the <code>my_thermometer</code> AEA and the <code>my_client</code> AEA. It also keeps track of the data that we offer for sale during the proposal phase.</p>
<h3 id="step-6-create-the-data_model">Step 6: Create the data_model</h3>
<p>Each AEA in the oef needs a Description in order to be able to register as a service. The data model will help us create this description. Create a new file and call it <code>thermometer_data_model.py</code> and paste the following code: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Attribute</span><span class="p">,</span> <span class="n">DataModel</span>

<span class="n">SCHEME</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"country"</span><span class="p">:</span> <span class="s2">"UK"</span><span class="p">,</span> <span class="s2">"city"</span><span class="p">:</span> <span class="s2">"Cambridge"</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">Thermometer_Datamodel</span><span class="p">(</span><span class="n">DataModel</span><span class="p">):</span>
    <span class="sd">"""Data model for the thermo Agent."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Initialise the dataModel."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attribute_country</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">(</span><span class="s2">"country"</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attribute_city</span> <span class="o">=</span> <span class="n">Attribute</span><span class="p">(</span><span class="s2">"city"</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">"thermometer_datamodel"</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">attribute_country</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_city</span><span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>
<p>This data model registers to the <a href="../oef-ledger">OEF search node</a> as an AEA that is in the UK and specifically in Cambridge. If a <code>client_AEA</code> searches for AEA in the UK the <a href="../oef-ledger">OEF search node</a> will respond with the address of our AEA.</p>
<h3 id="step-7-update-the-yaml-files">Step 7: Update the YAML files</h3>
<p>Since we made so many changes to our AEA we have to update the <code>skill.yaml</code> to contain our newly created scripts and the details that will be used from the strategy.</p>
<p>Firstly, we will update the <code>skill.yaml</code>. Make sure that your <code>skill.yaml</code> matches with the following code </p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">thermometer</span>
<span class="nt">author</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fetchai</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1.0</span>
<span class="nt">license</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Apache-2.0</span>
<span class="nt">fingerprint</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">aea_version</span><span class="p">:</span> <span class="s">'&gt;=0.3.0,</span><span class="nv"> </span><span class="s">&lt;0.4.0'</span>
<span class="nt">description</span><span class="p">:</span> <span class="s">"The</span><span class="nv"> </span><span class="s">thermometer</span><span class="nv"> </span><span class="s">skill</span><span class="nv"> </span><span class="s">implements</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">functionality</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">sell</span><span class="nv"> </span><span class="s">data."</span>
<span class="nt">behaviours</span><span class="p">:</span>
  <span class="nt">service_registration</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceRegistrationBehaviour</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">services_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">60</span>
<span class="nt">handlers</span><span class="p">:</span>
  <span class="nt">fipa</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FIPAHandler</span>
    <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">models</span><span class="p">:</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Strategy</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">price_per_row</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">seller_tx_fee</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
      <span class="nt">currency_id</span><span class="p">:</span> <span class="s">'FET'</span>
      <span class="nt">ledger_id</span><span class="p">:</span> <span class="s">'fetchai'</span>
      <span class="nt">has_sensor</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
      <span class="nt">is_ledger_tx</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
  <span class="nt">dialogues</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dialogues</span>
    <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">protocols</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'fetchai/fipa:0.1.0'</span><span class="p p-Indicator">,</span> <span class="s">'fetchai/oef_search:0.1.0'</span><span class="p p-Indicator">,</span> <span class="s">'fetchai/default:0.1.0'</span><span class="p p-Indicator">]</span>
<span class="nt">ledgers</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'fetchai'</span><span class="p p-Indicator">]</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="nt">pyserial</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">temper-py</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</code></pre></div>
<p>We must pay attention to the models and the strategy’s variables. Here we can change the price we would like to sell each reading for or the currency we would like to transact with. Lastly, the dependencies are the third party packages we need to install in order to get readings from the sensor. </p>
<p>Finally, we fingerprint our new skill:</p>
<div class="highlight"><pre><span></span><code>aea fingerprint skill thermometer
</code></pre></div>
<p>This will hash each file and save the hash in the fingerprint. This way, in the future we can easily track if any of the files have changed.</p>
<h2 id="client_aea">Client_AEA</h2>
<h3 id="step-1-create-the-aea_1">Step 1: Create the AEA</h3>
<p>Create a new AEA by typing the following command in the terminal:</p>
<div class="highlight"><pre><span></span><code>aea create my_client
<span class="nb">cd</span> my_client
</code></pre></div>
<p>Our newly created AEA is inside the current working directory. Let’s create our new skill that will handle the purchase of the thermometer data. Type the following command:</p>
<div class="highlight"><pre><span></span><code>aea scaffold skill thermometer_client
</code></pre></div>
<p>This command will create the correct structure for a new skill inside our AEA project You can locate the newly created skill inside the skills folder and it must contain the following files:</p>
<ul>
<li><code>behaviours.py</code></li>
<li><code>handlers.py</code></li>
<li><code>my_model.py</code></li>
<li><code>skills.yaml</code></li>
<li><code>__init__.py</code></li>
</ul>
<h3 id="step-2-create-the-behaviour_1">Step 2: Create the behaviour</h3>
<p>A Behaviour class contains the business logic specific to actions initiated by the AEA rather than reactions to other events.</p>
<p>Open the <code>behaviours.py</code> (<code>my_client/skills/thermometer_client/behaviours.py</code>) and add the following code:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">aea.crypto.ethereum</span> <span class="kn">import</span> <span class="n">ETHEREUM</span>
<span class="kn">from</span> <span class="nn">aea.crypto.fetchai</span> <span class="kn">import</span> <span class="n">FETCHAI</span>
<span class="kn">from</span> <span class="nn">aea.skills.behaviours</span> <span class="kn">import</span> <span class="n">TickerBehaviour</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.oef_search.message</span> <span class="kn">import</span> <span class="n">OefSearchMessage</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.oef_search.serialization</span> <span class="kn">import</span> <span class="n">OefSearchSerializer</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer_client.strategy</span> <span class="kn">import</span> <span class="n">Strategy</span>

<span class="n">DEFAULT_SEARCH_INTERVAL</span> <span class="o">=</span> <span class="mf">5.0</span>


<span class="k">class</span> <span class="nc">MySearchBehaviour</span><span class="p">(</span><span class="n">TickerBehaviour</span><span class="p">):</span>
    <span class="sd">"""This class implements a search behaviour."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""Initialize the search behaviour."""</span>
        <span class="n">search_interval</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
            <span class="nb">float</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"search_interval"</span><span class="p">,</span> <span class="n">DEFAULT_SEARCH_INTERVAL</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">tick_interval</span><span class="o">=</span><span class="n">search_interval</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Implement the setup for the behaviour."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_fetchai</span><span class="p">:</span>
            <span class="n">fet_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">FETCHAI</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FETCHAI</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">fet_balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: starting balance on fetchai ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">fet_balance</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: you have no starting balance on fetchai ledger!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># TODO: deregister skill from filter</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_ethereum</span><span class="p">:</span>
            <span class="n">eth_balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">ETHEREUM</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ETHEREUM</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">eth_balance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: starting balance on ethereum ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">eth_balance</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: you have no starting balance on ethereum ledger!"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># TODO: deregister skill from filter</span>

    <span class="k">def</span> <span class="nf">act</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the act.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">.</span><span class="n">is_searching</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_service_query</span><span class="p">()</span>
            <span class="n">search_id</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_next_search_id</span><span class="p">()</span>
            <span class="n">oef_msg</span> <span class="o">=</span> <span class="n">OefSearchMessage</span><span class="p">(</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">SEARCH_SERVICES</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">search_id</span><span class="p">),</span> <span class="s2">""</span><span class="p">),</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">search_service_address</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">OefSearchSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">oef_msg</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the task teardown.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_fetchai</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">FETCHAI</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FETCHAI</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: ending balance on fetchai ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">balance</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">has_ethereum</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span>
                <span class="n">ETHEREUM</span><span class="p">,</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ETHEREUM</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: ending balance on ethereum ledger=</span><span class="si">{}</span><span class="s2">."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">balance</span>
                <span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>
<p>This Behaviour will search on  the<a href="../oef-ledger">OEF search node</a> with a specific query at regular tick intervals. </p>
<h3 id="step-3-create-the-handler_1">Step 3: Create the handler</h3>
<p>So far, we have tasked the AEA with sending search queries to the <a href="../oef-ledger">OEF search node</a>. However, we have so far no way of handling the responses sent to the AEA by the <a href="../oef-ledger">OEF search node</a> or messages sent by other agent.</p>
<p>This script contains the logic to negotiate with another AEA based on the strategy we want our AEA to follow:</p>
<p><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">aea.configurations.base</span> <span class="kn">import</span> <span class="n">ProtocolId</span><span class="p">,</span> <span class="n">PublicId</span>
<span class="kn">from</span> <span class="nn">aea.decision_maker.messages.transaction</span> <span class="kn">import</span> <span class="n">TransactionMessage</span>
<span class="kn">from</span> <span class="nn">aea.helpers.dialogue.base</span> <span class="kn">import</span> <span class="n">DialogueLabel</span>
<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Description</span>
<span class="kn">from</span> <span class="nn">aea.protocols.base</span> <span class="kn">import</span> <span class="n">Message</span>
<span class="kn">from</span> <span class="nn">aea.protocols.default.message</span> <span class="kn">import</span> <span class="n">DefaultMessage</span>
<span class="kn">from</span> <span class="nn">aea.protocols.default.serialization</span> <span class="kn">import</span> <span class="n">DefaultSerializer</span>
<span class="kn">from</span> <span class="nn">aea.skills.base</span> <span class="kn">import</span> <span class="n">Handler</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.fipa.message</span> <span class="kn">import</span> <span class="n">FipaMessage</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.fipa.serialization</span> <span class="kn">import</span> <span class="n">FipaSerializer</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.oef_search.message</span> <span class="kn">import</span> <span class="n">OefSearchMessage</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer_client.dialogues</span> <span class="kn">import</span> <span class="n">Dialogue</span><span class="p">,</span> <span class="n">Dialogues</span>
<span class="kn">from</span> <span class="nn">packages.fetchai.skills.thermometer_client.strategy</span> <span class="kn">import</span> <span class="n">Strategy</span>


<span class="k">class</span> <span class="nc">FIPAHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">"""This class scaffolds a handler."""</span>

    <span class="n">SUPPORTED_PROTOCOL</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span>  <span class="c1"># type: Optional[ProtocolId]</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the setup.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the reaction to a message.</span>

<span class="sd">        :param message: the message</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="c1"># convenience representations</span>
        <span class="n">fipa_msg</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">FipaMessage</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

        <span class="c1"># recover dialogue</span>
        <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">is_belonging_to_registered_dialogue</span><span class="p">(</span>
            <span class="n">fipa_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span>
        <span class="p">):</span>
            <span class="n">dialogue</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="p">,</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">get_dialogue</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">incoming_extend</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_unidentified_dialogue</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># handle message</span>
        <span class="k">if</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">PROPOSE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_propose</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">DECLINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_decline</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">MATCH_ACCEPT_W_INFORM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_match_accept</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">performative</span> <span class="o">==</span> <span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">INFORM</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_inform</span><span class="p">(</span><span class="n">fipa_msg</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the handler teardown.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">pass</span>
</code></pre></div>
You will see that we are following similar logic when we develop the client’s side of the negotiation. The first thing is that we create a new dialogue and we store it in the dialogues class. Then we are checking what kind of message we received. So lets start creating our handlers:</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_unidentified_dialogue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle an unidentified dialogue.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: unidentified dialogue."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">default_msg</span> <span class="o">=</span> <span class="n">DefaultMessage</span><span class="p">(</span>
            <span class="n">dialogue_reference</span><span class="o">=</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span> <span class="s2">""</span><span class="p">),</span>
            <span class="n">message_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">performative</span><span class="o">=</span><span class="n">DefaultMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span>
            <span class="n">error_code</span><span class="o">=</span><span class="n">DefaultMessage</span><span class="o">.</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">INVALID_DIALOGUE</span><span class="p">,</span>
            <span class="n">error_msg</span><span class="o">=</span><span class="s2">"Invalid dialogue."</span><span class="p">,</span>
            <span class="n">error_data</span><span class="o">=</span><span class="p">{</span><span class="s2">"fipa_message"</span><span class="p">:</span> <span class="sa">b</span><span class="s2">""</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
            <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
            <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
            <span class="n">protocol_id</span><span class="o">=</span><span class="n">DefaultMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">DefaultSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">default_msg</span><span class="p">),</span>
        <span class="p">)</span>
</code></pre></div>
The above code handles the unidentified dialogues. And responds with an error message to the sender. Next we will handle the proposal that we receive from the <code>my_thermometer</code> AEA: </p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_propose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the propose.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">new_message_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">new_target_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span>
        <span class="n">proposal</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">proposal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received proposal=</span><span class="si">{}</span><span class="s2"> from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="n">acceptable</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">is_acceptable_proposal</span><span class="p">(</span><span class="n">proposal</span><span class="p">)</span>
        <span class="n">affordable</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">is_affordable_proposal</span><span class="p">(</span><span class="n">proposal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">acceptable</span> <span class="ow">and</span> <span class="n">affordable</span><span class="p">:</span>
            <span class="n">strategy</span><span class="o">.</span><span class="n">is_searching</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: accepting the proposal from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="n">proposal</span>
            <span class="n">accept_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target_id</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">ACCEPT</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">accept_msg</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: declining the proposal from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">decline_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target_id</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">DECLINE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">decline_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">decline_msg</span><span class="p">),</span>
            <span class="p">)</span>
</code></pre></div>
When we receive a proposal we have to check if we have the funds to complete the transaction and if the proposal is acceptable based on our strategy. If the proposal is not affordable or acceptable we respond with a decline message. Otherwise, we send an accept message to the seller. The next code-block handles the decline message that we may receive from the client on our CFP message or our ACCEPT message:</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_decline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the decline.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received DECLINE from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"target"</span><span class="p">)</span>
        <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogue_stats</span><span class="o">.</span><span class="n">add_dialogue_endstate</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="o">.</span><span class="n">EndState</span><span class="o">.</span><span class="n">DECLINED_CFP</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">is_self_initiated</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">target</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogue_stats</span><span class="o">.</span><span class="n">add_dialogue_endstate</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="o">.</span><span class="n">EndState</span><span class="o">.</span><span class="n">DECLINED_ACCEPT</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">is_self_initiated</span>
            <span class="p">)</span>
</code></pre></div>
The above code terminates each dialogue with the specific aea and stores the step. For example, if the <code>target == 1</code> we know that the seller declined our CFP message. In case you didn’t receive any decline message that means that the <code>my_thermometer</code> AEA want to move on with the sale, in that case, it will send a <code>match_accept</code> message in order to handle this add the following code : </p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_match_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the match accept.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strategy</span><span class="o">.</span><span class="n">is_ledger_tx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received MATCH_ACCEPT_W_INFORM from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"address"</span><span class="p">))</span>
            <span class="n">proposal</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Description</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">proposal</span><span class="p">)</span>
            <span class="n">tx_msg</span> <span class="o">=</span> <span class="n">TransactionMessage</span><span class="p">(</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">TransactionMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">PROPOSE_FOR_SETTLEMENT</span><span class="p">,</span>
                <span class="n">skill_callback_ids</span><span class="o">=</span><span class="p">[</span><span class="n">PublicId</span><span class="p">(</span><span class="s2">"fetchai"</span><span class="p">,</span> <span class="s2">"thermometer_client"</span><span class="p">,</span> <span class="s2">"0.1.0"</span><span class="p">)],</span>
                <span class="n">tx_id</span><span class="o">=</span><span class="s2">"transaction0"</span><span class="p">,</span>
                <span class="n">tx_sender_addr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="p">[</span>
                    <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"ledger_id"</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">tx_counterparty_addr</span><span class="o">=</span><span class="n">address</span><span class="p">,</span>
                <span class="n">tx_amount_by_currency_id</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"currency_id"</span><span class="p">]:</span> <span class="o">-</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"price"</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="n">tx_sender_fee</span><span class="o">=</span><span class="n">strategy</span><span class="o">.</span><span class="n">max_buyer_tx_fee</span><span class="p">,</span>
                <span class="n">tx_counterparty_fee</span><span class="o">=</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"seller_tx_fee"</span><span class="p">],</span>
                <span class="n">tx_quantities_by_good_id</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">ledger_id</span><span class="o">=</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"ledger_id"</span><span class="p">],</span>
                <span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s2">"dialogue_label"</span><span class="p">:</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">json</span><span class="p">},</span>
                <span class="n">tx_nonce</span><span class="o">=</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"tx_nonce"</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">decision_maker_message_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">tx_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: proposing the transaction to the decision maker. Waiting for confirmation ..."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_message_id</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">new_target</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message_id</span>
            <span class="n">inform_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">INFORM</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="p">{</span><span class="s2">"Done"</span><span class="p">:</span> <span class="s2">"Sending payment via bank transfer"</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: informing counterparty=</span><span class="si">{}</span><span class="s2"> of payment."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>
The first thing we are checking is if we enabled our aea to transact with a ledger. If we can transact with a ledger we generate a transaction message and we propose it to the <code>decision_maker</code>. The <code>decision_maker</code> then will check the transaction message if it is acceptable, we have the funds, etc, it signs and sends the transaction to the specified ledger. Then it returns us the transaction digest. 
Lastly, we need to handle the inform message because this is the message that will have our data:</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_handle_inform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="p">:</span> <span class="n">Dialogue</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the match inform.</span>

<span class="sd">        :param msg: the message</span>
<span class="sd">        :param dialogue: the dialogue object</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received INFORM from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">"thermometer_data"</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">thermometer_data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">"thermometer_data"</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received the following thermometer data=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">thermometer_data</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
            <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogue_stats</span><span class="o">.</span><span class="n">add_dialogue_endstate</span><span class="p">(</span>
                <span class="n">Dialogue</span><span class="o">.</span><span class="n">EndState</span><span class="o">.</span><span class="n">SUCCESSFUL</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">is_self_initiated</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: received no data from sender=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">counterparty</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>
The main difference between this handler and the <code>thermometer</code> skill handler is that in this one we create more than one handler. 
The reason is that we receive messages not only from the <code>my_thermometer</code> AEA but also from the <code>decision_maker</code> and the <a href="../oef-ledger">OEF search node</a>. So we need a handler to be able to read different kinds of messages.</p>
<p>To handle the <a href="../oef-ledger">OEF search node</a> response on our search request adds the following code in the same file:</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">OEFSearchHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">"""This class handles OEF search responses."""</span>

    <span class="n">SUPPORTED_PROTOCOL</span> <span class="o">=</span> <span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">protocol_id</span>  <span class="c1"># type: Optional[ProtocolId]</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Call to setup the handler."""</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the reaction to a message.</span>

<span class="sd">        :param message: the message</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="c1"># convenience representations</span>
        <span class="n">oef_msg</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">OefSearchMessage</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oef_msg</span><span class="o">.</span><span class="n">performative</span> <span class="ow">is</span> <span class="n">OefSearchMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">SEARCH_RESULT</span><span class="p">:</span>
            <span class="n">agents</span> <span class="o">=</span> <span class="n">oef_msg</span><span class="o">.</span><span class="n">agents</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle_search</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the handler teardown.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_handle_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agents</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Handle the search response.</span>

<span class="sd">        :param agents: the agents returned by the search</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: found agents=</span><span class="si">{}</span><span class="s2">, stopping search."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:],</span> <span class="n">agents</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
            <span class="c1"># stopping search</span>
            <span class="n">strategy</span><span class="o">.</span><span class="n">is_searching</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># pick first agent found</span>
            <span class="n">opponent_addr</span> <span class="o">=</span> <span class="n">agents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
            <span class="n">dialogue</span> <span class="o">=</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">create_self_initiated</span><span class="p">(</span>
                <span class="n">opponent_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span> <span class="n">is_seller</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_service_query</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: sending CFP to agent=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">opponent_addr</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">cfp_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">Dialogue</span><span class="o">.</span><span class="n">STARTING_MESSAGE_ID</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">CFP</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">Dialogue</span><span class="o">.</span><span class="n">STARTING_TARGET</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">cfp_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">opponent_addr</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">cfp_msg</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: found no agents, continue searching."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span>
                <span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>
When we receive a message from the oef of a type <code>OefSearchMessage.Performative.SEARCH_RESULT</code>, we are passing the details to the handle function. The latest calls the <code>_handle_search</code> function and passes as input to the agent list. There we are checking that the list contains some agents and we stop the search. We pick our first agent and we send a CFP message.</p>
<p>The last handler we will need is the <code>MyTransactionHandler</code>. This one will handle the internal messages that we receive from the <code>decision_maker</code>.</p>
<p><div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyTransactionHandler</span><span class="p">(</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">"""Implement the transaction handler."""</span>

    <span class="n">SUPPORTED_PROTOCOL</span> <span class="o">=</span> <span class="n">TransactionMessage</span><span class="o">.</span><span class="n">protocol_id</span>  <span class="c1"># type: Optional[ProtocolId]</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""Implement the setup for the handler."""</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the reaction to a message.</span>

<span class="sd">        :param message: the message</span>
<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">tx_msg_response</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">TransactionMessage</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">tx_msg_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">tx_msg_response</span><span class="o">.</span><span class="n">performative</span>
            <span class="o">==</span> <span class="n">TransactionMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">SUCCESSFUL_SETTLEMENT</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: transaction was successful."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"transaction_digest"</span><span class="p">:</span> <span class="n">tx_msg_response</span><span class="o">.</span><span class="n">tx_digest</span><span class="p">}</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tx_msg_response</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            <span class="n">dialogue_label</span> <span class="o">=</span> <span class="n">DialogueLabel</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span>
                <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dialogue_label"</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">dialogues</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dialogues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">dialogues</span><span class="p">)</span>
            <span class="n">dialogue</span> <span class="o">=</span> <span class="n">dialogues</span><span class="o">.</span><span class="n">dialogues</span><span class="p">[</span><span class="n">dialogue_label</span><span class="p">]</span>
            <span class="n">fipa_msg</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">FipaMessage</span><span class="p">,</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">last_incoming_message</span><span class="p">)</span>
            <span class="n">new_message_id</span> <span class="o">=</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">message_id</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">new_target_id</span> <span class="o">=</span> <span class="n">fipa_msg</span><span class="o">.</span><span class="n">message_id</span>
            <span class="n">counterparty_addr</span> <span class="o">=</span> <span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_opponent_addr</span>
            <span class="n">inform_msg</span> <span class="o">=</span> <span class="n">FipaMessage</span><span class="p">(</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">new_message_id</span><span class="p">,</span>
                <span class="n">dialogue_reference</span><span class="o">=</span><span class="n">dialogue</span><span class="o">.</span><span class="n">dialogue_label</span><span class="o">.</span><span class="n">dialogue_reference</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">new_target_id</span><span class="p">,</span>
                <span class="n">performative</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">Performative</span><span class="o">.</span><span class="n">INFORM</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">dialogue</span><span class="o">.</span><span class="n">outgoing_extend</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">outbox</span><span class="o">.</span><span class="n">put_message</span><span class="p">(</span>
                <span class="n">to</span><span class="o">=</span><span class="n">counterparty_addr</span><span class="p">,</span>
                <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_address</span><span class="p">,</span>
                <span class="n">protocol_id</span><span class="o">=</span><span class="n">FipaMessage</span><span class="o">.</span><span class="n">protocol_id</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">FipaSerializer</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">inform_msg</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: informing counterparty=</span><span class="si">{}</span><span class="s2"> of transaction digest."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">,</span> <span class="n">counterparty_addr</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">"[</span><span class="si">{}</span><span class="s2">]: transaction was not successful."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_name</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Implement the handler teardown.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="k">pass</span>
</code></pre></div>
Remember that we send a message to the <code>decision_maker</code> with a transaction proposal? Here we handle the response from the <code>decision_maker</code>.</p>
<p>If the message is of type SUCCESFUL_SETTLEMENT, we generate the inform_msg for the seller_aea to inform him that we completed the transaction and transferred the funds to the address that he sent us and we pass the transaction digest so the other aea can verify the transaction. Otherwise, the <code>decision_maker</code> will inform us that something went wrong and the transaction was not successful.</p>
<h3 id="step-4-create-the-strategy_1">Step 4: Create the strategy</h3>
<p>We are going to create the strategy that we want our AEA to follow. Rename the <code>my_model.py</code> file to <code>strategy.py</code> and paste the following code: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>

<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Constraint</span><span class="p">,</span> <span class="n">ConstraintType</span><span class="p">,</span> <span class="n">Description</span><span class="p">,</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">aea.skills.base</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="n">DEFAULT_COUNTRY</span> <span class="o">=</span> <span class="s2">"UK"</span>
<span class="n">SEARCH_TERM</span> <span class="o">=</span> <span class="s2">"country"</span>
<span class="n">DEFAULT_MAX_ROW_PRICE</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">DEFAULT_MAX_TX_FEE</span> <span class="o">=</span> <span class="mi">20000000</span>
<span class="n">DEFAULT_CURRENCY_PBK</span> <span class="o">=</span> <span class="s2">"ETH"</span>
<span class="n">DEFAULT_LEDGER_ID</span> <span class="o">=</span> <span class="s2">"ethereum"</span>
<span class="n">DEFAULT_IS_LEDGER_TX</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">Strategy</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">"""This class defines a strategy for the agent."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Initialize the strategy of the agent.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_country</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"country"</span><span class="p">,</span> <span class="n">DEFAULT_COUNTRY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_row_price</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"max_row_price"</span><span class="p">,</span> <span class="n">DEFAULT_MAX_ROW_PRICE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_buyer_tx_fee</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"max_tx_fee"</span><span class="p">,</span> <span class="n">DEFAULT_MAX_TX_FEE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currency_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"currency_id"</span><span class="p">,</span> <span class="n">DEFAULT_CURRENCY_PBK</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ledger_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"ledger_id"</span><span class="p">,</span> <span class="n">DEFAULT_LEDGER_ID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ledger_tx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">"is_ledger_tx"</span><span class="p">,</span> <span class="n">DEFAULT_IS_LEDGER_TX</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_searching</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
<p>We initialize the strategy class. We are trying to read the strategy variables from the YAML file. If this is not possible we specified some default values. The following two functions are related to the oef search service, add them under the initialization of the class:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_next_search_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Get the next search id and set the search time.</span>

<span class="sd">        :return: the next search id</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_search_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_id</span>

    <span class="k">def</span> <span class="nf">get_service_query</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Query</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Get the service query of the agent.</span>

<span class="sd">        :return: the query</span>
<span class="sd">        """</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span>
            <span class="p">[</span><span class="n">Constraint</span><span class="p">(</span><span class="n">SEARCH_TERM</span><span class="p">,</span> <span class="n">ConstraintType</span><span class="p">(</span><span class="s2">"=="</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_country</span><span class="p">))],</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>
</code></pre></div>
<p>The following code block checks if the proposal that we received is acceptable based on the strategy</p>
<p><div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">is_acceptable_proposal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposal</span><span class="p">:</span> <span class="n">Description</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Check whether it is an acceptable proposal.</span>

<span class="sd">        :return: whether it is acceptable</span>
<span class="sd">        """</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"price"</span><span class="p">]</span> <span class="o">-</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"seller_tx_fee"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"price"</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_row_price</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"currency_id"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_currency_id</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"ledger_id"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ledger_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
The <code>is_affordable_proposal</code> checks if we can afford the transaction based on the funds we have in our wallet 
on the ledger.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">is_affordable_proposal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proposal</span><span class="p">:</span> <span class="n">Description</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Check whether it is an affordable proposal.</span>

<span class="sd">        :return: whether it is affordable</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ledger_tx</span><span class="p">:</span>
            <span class="n">payable</span> <span class="o">=</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"price"</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_buyer_tx_fee</span>
            <span class="n">ledger_id</span> <span class="o">=</span> <span class="n">proposal</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s2">"ledger_id"</span><span class="p">]</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">agent_addresses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ledger_id</span><span class="p">))</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">ledger_apis</span><span class="o">.</span><span class="n">token_balance</span><span class="p">(</span><span class="n">ledger_id</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">balance</span> <span class="o">&gt;=</span> <span class="n">payable</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h3 id="step-5-create-the-dialogues_1">Step 5: Create the dialogues</h3>
<p>When we are negotiating with other AEA we would like to keep track of these negotiations for various reasons. Create a new file and name it <code>dialogues.py</code>. Inside this file add the following code: </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">aea.helpers.dialogue.base</span> <span class="kn">import</span> <span class="n">DialogueLabel</span>
<span class="kn">from</span> <span class="nn">aea.helpers.search.models</span> <span class="kn">import</span> <span class="n">Description</span>
<span class="kn">from</span> <span class="nn">aea.skills.base</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="kn">from</span> <span class="nn">packages.fetchai.protocols.fipa.dialogues</span> <span class="kn">import</span> <span class="n">FipaDialogue</span><span class="p">,</span> <span class="n">FipaDialogues</span>


<span class="k">class</span> <span class="nc">Dialogue</span><span class="p">(</span><span class="n">FipaDialogue</span><span class="p">):</span>
    <span class="sd">"""The dialogue class maintains state of a dialogue and manages it."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialogue_label</span><span class="p">:</span> <span class="n">DialogueLabel</span><span class="p">,</span> <span class="n">is_seller</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Initialize a dialogue label.</span>

<span class="sd">        :param dialogue_label: the identifier of the dialogue</span>
<span class="sd">        :param is_seller: indicates whether the agent associated with the dialogue is a seller or buyer</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">FipaDialogue</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialogue_label</span><span class="o">=</span><span class="n">dialogue_label</span><span class="p">,</span> <span class="n">is_seller</span><span class="o">=</span><span class="n">is_seller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[Description]</span>


<span class="k">class</span> <span class="nc">Dialogues</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">FipaDialogues</span><span class="p">):</span>
    <span class="sd">"""The dialogues class keeps track of all dialogues."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Initialize dialogues.</span>

<span class="sd">        :return: None</span>
<span class="sd">        """</span>
        <span class="n">Model</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">FipaDialogues</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<p>The dialogues class stores dialogue with each <code>my_thermometer</code> AEA in a list so we can have access to previous messages and enable us to identify possible communications problems between the <code>my_thermometer</code> AEA and the <code>my_client</code> AEA.</p>
<h3 id="step-6-update-the-yaml-files">Step 6: Update the YAML files</h3>
<p>Since we made so many changes to our aea we have to update the <code>skill.yaml</code> to contain our newly created scripts and the details that will be used from the strategy.</p>
<p>Firstly, we will update the <code>skill.yaml</code>. Make sure that your <code>skill.yaml</code> matches with the following code:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">thermometer_client</span>
<span class="nt">author</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fetchai</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1.0</span>
<span class="nt">license</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Apache-2.0</span>
<span class="nt">fingerprint</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">aea_version</span><span class="p">:</span> <span class="s">'&gt;=0.3.0,</span><span class="nv"> </span><span class="s">&lt;0.4.0'</span>
<span class="nt">description</span><span class="p">:</span> <span class="s">"The</span><span class="nv"> </span><span class="s">thermometer</span><span class="nv"> </span><span class="s">client</span><span class="nv"> </span><span class="s">skill</span><span class="nv"> </span><span class="s">implements</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">skill</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">purchase</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">data."</span>
<span class="nt">behaviours</span><span class="p">:</span>
  <span class="nt">search</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MySearchBehaviour</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">search_interval</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="nt">handlers</span><span class="p">:</span>
  <span class="nt">fipa</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">FIPAHandler</span>
    <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">oef</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">OEFHandler</span>
    <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
  <span class="nt">transaction</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MyTransactionHandler</span>
    <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">models</span><span class="p">:</span>
  <span class="nt">strategy</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Strategy</span>
    <span class="nt">args</span><span class="p">:</span>
      <span class="nt">country</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">UK</span>
      <span class="nt">max_row_price</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
      <span class="nt">max_tx_fee</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2000000</span>
      <span class="nt">currency_id</span><span class="p">:</span> <span class="s">'FET'</span>
      <span class="nt">ledger_id</span><span class="p">:</span> <span class="s">'fetchai'</span>
      <span class="nt">is_ledger_tx</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
  <span class="nt">dialogues</span><span class="p">:</span>
    <span class="nt">class_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Dialogues</span>
    <span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">protocols</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'fetchai/fipa:0.1.0'</span><span class="p p-Indicator">,</span><span class="s">'fetchai/default:0.1.0'</span><span class="p p-Indicator">,</span><span class="s">'fetchai/oef_search:0.1.0'</span><span class="p p-Indicator">]</span>
<span class="nt">ledgers</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">'fetchai'</span><span class="p p-Indicator">]</span>
</code></pre></div>
We must pay attention to the models and the strategy’s variables. Here we can change the price we would like to buy each reading or the currency we would like to transact with. </p>
<p>Finally, we fingerprint our new skill:</p>
<div class="highlight"><pre><span></span><code>aea fingerprint skill thermometer
</code></pre></div>
<p>This will hash each file and save the hash in the fingerprint. This way, in the future we can easily track if any of the files have changed.</p>
<h2 id="run-the-aeas">Run the AEAs</h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure that your thermometer sensor is connected to the Raspberry's usb port.</p>
</div>
<p>You can change the end-point's address and port by modifying the connection's yaml file (<code>*/connection/oef/connection.yaml</code>)</p>
<p>Under config locate:</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">addr</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${OEF_ADDR</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1}</span>
</code></pre></div>
and replace it with your ip (The ip of the machine that runs the oef image.)</p>
<p>In a separate terminal, launch a local <a href="../oef-ledger">OEF search and communication node</a>.
<div class="highlight"><pre><span></span><code>python scripts/oef/launch.py -c ./scripts/oef/launch_config.json
</code></pre></div></p>
<h3 id="fetchai-ledger-payment">Fetch.ai ledger payment</h3>
<p>Create the private key for the weather client AEA.</p>
<div class="highlight"><pre><span></span><code>aea generate-key fetchai
aea add-key fetchai fet_private_key.txt
</code></pre></div>
<h3 id="update-the-aea-configs">Update the AEA configs</h3>
<p>Both in <code>my_thermometer/aea-config.yaml</code> and <code>my_client/aea-config.yaml</code>, replace <code>ledger_apis</code>: {} with the following.
<div class="highlight"><pre><span></span><code><span class="nt">ledger_apis</span><span class="p">:</span>
  <span class="nt">fetchai</span><span class="p">:</span>
    <span class="nt">network</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testnet</span>
</code></pre></div></p>
<h3 id="fund-the-temperature-client-aea">Fund the temperature client AEA</h3>
<p>Create some wealth for your weather client on the Fetch.ai testnet. (It takes a while).</p>
<div class="highlight"><pre><span></span><code>aea generate-wealth fetchai
</code></pre></div>
<p>Run both AEAs from their respective terminals</p>
<p><div class="highlight"><pre><span></span><code>aea add connection fetchai/oef:0.2.0
aea install
aea config <span class="nb">set</span> agent.default_connection fetchai/oef:0.2.0
aea run --connections fetchai/oef:0.2.0
</code></pre></div>
You will see that the AEAs negotiate and then transact using the Fetch.ai testnet.</p>
<h3 id="ethereum-ledger-payment">Ethereum ledger payment</h3>
<p>A demo to run the same scenario but with a true ledger transaction on the Ethereum Ropsten testnet. 
This demo assumes the temperature client trusts our AEA to send the temperature data upon successful payment.</p>
<p>Create the private key for the <code>my_client</code> AEA.</p>
<div class="highlight"><pre><span></span><code>aea generate-key ethereum
aea add-key ethereum eth_private_key.txt
</code></pre></div>
<h3 id="update-the-aea-configs_1">Update the AEA configs</h3>
<p>Both in <code>my_thermometer/aea-config.yaml</code> and <code>my_client/aea-config.yaml</code>, replace <code>ledger_apis: {}</code> with the following.</p>
<div class="highlight"><pre><span></span><code><span class="nt">ledger_apis</span><span class="p">:</span>
  <span class="nt">ethereum</span><span class="p">:</span>
    <span class="nt">address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">https://ropsten.infura.io/v3/f00f7b3ba0e848ddbdc8941c527447fe</span>
    <span class="nt">chain_id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
    <span class="nt">gas_price</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
</code></pre></div>
<h3 id="update-the-skill-configs">Update the skill configs</h3>
<p>In the thermometer skill config (<code>my_thermometer/skills/thermometer/skill.yaml</code>) under strategy, amend the <code>currency_id</code> and <code>ledger_id</code> as follows.</p>
<div class="highlight"><pre><span></span><code><span class="nt">currency_id</span><span class="p">:</span> <span class="s">'ETH'</span>
<span class="nt">ledger_id</span><span class="p">:</span> <span class="s">'ethereum'</span>
<span class="nt">is_ledger_tx</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</code></pre></div>
<p>In the <code>temprature_client</code> skill config (<code>my_client/skills/temprature_client/skill.yaml</code>) under strategy change the <code>currency_id</code> and <code>ledger_id</code>.</p>
<div class="highlight"><pre><span></span><code><span class="nt">max_buyer_tx_fee</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">20000</span>
<span class="nt">currency_id</span><span class="p">:</span> <span class="s">'ETH'</span>
<span class="nt">ledger_id</span><span class="p">:</span> <span class="s">'ethereum'</span>
<span class="nt">is_ledger_tx</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</code></pre></div>
<h3 id="fund-the-thermometer-client-aea">Fund the thermometer client AEA</h3>
<p>Create some wealth for your weather client on the Ethereum Ropsten test net.
Go to the <a href="https://faucet.metamask.io/"> MetaMask Faucet </a> and request some test ETH for the account your weather client AEA is using (you need to first load your AEAs private key into MetaMask). Your private key is at <code>my_client/eth_private_key.txt</code>.</p>
<p>Run both AEAs from their respective terminals.</p>
<div class="highlight"><pre><span></span><code>aea add connection fetchai/oef:0.2.0
aea install
aea config <span class="nb">set</span> agent.default_connection fetchai/oef:0.2.0
aea run --connections fetchai/oef:0.2.0
</code></pre></div>
<p>You will see that the AEAs negotiate and then transact using the Ethereum testnet.</p>
<h2 id="delete-the-aeas">Delete the AEAs</h2>
<p>When you're done, go up a level and delete the AEAs.
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> ..
aea delete my_thermometer
aea delete my_client
</code></pre></div></p>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a class="md-flex md-footer-nav__link md-footer-nav__link--prev" href="../cli-vs-programmatic-aeas/" rel="prev" title="CLI vs programmatic AEAs">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                CLI vs programmatic AEAs
              </span>
</div>
</a>
<a class="md-flex md-footer-nav__link md-footer-nav__link--next" href="../generic-skills/" rel="next" title="Generic skills">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                Generic skills
              </span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" rel="noopener" target="_blank">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs</a>
</div>
</div>
</div>
</footer>
</div>
<script src="../assets/javascripts/application.c33a9706.js"></script>
<script>app.initialize({version:"1.1",url:{base:".."}})</script>
<script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script>
</body>
</html>